(function(R,O){typeof exports=="object"&&typeof module<"u"?O(exports):typeof define=="function"&&define.amd?define(["exports"],O):(R=typeof globalThis<"u"?globalThis:R||self,O(R.SavgClick2Call={}))})(this,function(R){"use strict";class O{constructor(){this.handlers={}}on(t,a){this.handlers[t]||(this.handlers[t]=new Set),this.handlers[t].add(a)}off(t,a){var r;(r=this.handlers[t])==null||r.delete(a)}emit(t,...a){var r;(r=this.handlers[t])==null||r.forEach(l=>l(...a))}}const G="REPLACE_ME_USER",K="REPLACE_ME_PASSWORD";class lt{constructor(t){this.emitter=new O,this.ua=null,this.isJsSipUA=!1,this.lastSession=null,this.isRegistered=!1,this.remoteAudioEl=null,this.config={autoGreet:!1,greetUrl:"/hello.mp3",...t},this.config.audio={outputDeviceId:"default",...this.config.audio||{}}}on(t,a){this.emitter.on(t,a)}off(t,a){this.emitter.off(t,a)}ensureRemoteAudioEl(){if(this.remoteAudioEl)return this.remoteAudioEl;const t=document.createElement("audio");return t.autoplay=!0,t.playsInline=!0,t.style.display="none",t.id="savg-c2c-remote-audio",document.body.appendChild(t),this.remoteAudioEl=t,t}async setSinkId(t,a){if(!(typeof t.sinkId>"u"))try{await t.setSinkId(a)}catch{}}async register(){var e,d,c;const t=window,a=t.AudioCodesUA||((e=t.JsSIP)==null?void 0:e.AudioCodesUA);if(a){if(!this.ua){const o={serverConfig:{addresses:[this.config.sbcWssUrl],domain:this.config.sipDomain},account:{user:`${G}@${this.config.sipDomain}`,userAuth:G,displayName:this.config.displayName||G,password:K,registerExpires:600},constraints:{audio:!0,video:!1},iceServers:this.config.iceServers};try{this.ua=new a(o)}catch{const f=(a==null?void 0:a.default)||(a==null?void 0:a.UA)||(a==null?void 0:a.AudioCodesUA)||a;this.ua=new f(o)}}this.isJsSipUA=!1,this.emitter.emit("registration:attempt"),await((c=(d=this.ua).start)==null?void 0:c.call(d)),this.isRegistered=!0,this.emitter.emit("registration:success");return}if(!t.JsSIP)throw new Error("AudioCodesUA not found. Ensure ac_webrtc.min.js is loaded before app.js");const l={sockets:[new t.JsSIP.WebSocketInterface(this.config.sbcWssUrl)],uri:`sip:${G}@${this.config.sipDomain}`,password:K,display_name:this.config.displayName||G,session_timers:!1,register:!0,register_expires:600};this.ua||(this.ua=new t.JsSIP.UA(l),this.isJsSipUA=!0,this.ua.on("registered",()=>{this.isRegistered=!0,this.emitter.emit("registration:success")}),this.ua.on("unregistered",()=>{this.isRegistered=!1}),this.ua.on("registrationFailed",o=>{this.isRegistered=!1,this.emitter.emit("registration:error",o==null?void 0:o.cause)}),this.ua.on("newRTCSession",o=>{var g;this.lastSession=o.session;const f=this.ensureRemoteAudioEl(),s=(g=this.lastSession)==null?void 0:g.connection;s&&s.addEventListener("track",u=>{const k=u.streams&&u.streams[0];k&&(f.srcObject=k)})})),!this.isRegistered&&(this.emitter.emit("registration:attempt"),await new Promise((o,f)=>{const s=()=>{this.isRegistered=!0,this.emitter.emit("registration:success"),o()},g=u=>{this.isRegistered=!1,this.emitter.emit("registration:error",u==null?void 0:u.cause),f(new Error((u==null?void 0:u.cause)||"registrationFailed"))};try{this.ua.on("registered",s),this.ua.on("registrationFailed",g)}catch{}this.ua.start()}))}async unregister(){var t,a;await((a=(t=this.ua)==null?void 0:t.stop)==null?void 0:a.call(t))}async call(t){var c,o,f;const a=(t==null?void 0:t.to)||`sip:${this.config.botId}@${this.config.sipDomain}`,r={"X-PHONE-NUMBER":this.config.phoneNumber,"X-Bot-Id":this.config.botId,...this.config.context?{"X-CTC-Context":this.config.context}:{},...this.config.headers||{},...(t==null?void 0:t.headers)||{}},l=this.ensureRemoteAudioEl();await this.setSinkId(l,((c=this.config.audio)==null?void 0:c.outputDeviceId)||"default");let e=null;if(this.isJsSipUA){const g={extraHeaders:Object.entries(r).map(([u,k])=>`${u}: ${k}`),mediaConstraints:{audio:!0,video:!1},pcConfig:{iceServers:this.config.iceServers}};e=this.ua.call(a,g)}else e=await((f=(o=this.ua)==null?void 0:o.call)==null?void 0:f.call(o,a,{headers:r}));if(e!=null&&e.getRemoteStream){const s=e.getRemoteStream();l.srcObject=s}const d={hangup:async()=>{try{if(e!=null&&e.isEnded&&e.isEnded())return;typeof(e==null?void 0:e.bye)=="function"?await e.bye():typeof(e==null?void 0:e.terminate)=="function"&&await e.terminate()}catch{}},mute:()=>{var s;(s=e==null?void 0:e.mute)==null||s.call(e,{audio:!0})},unmute:()=>{var s;(s=e==null?void 0:e.unmute)==null||s.call(e,{audio:!0})},hold:async()=>{var s,g;await(((s=e==null?void 0:e.hold)==null?void 0:s.call(e))??((g=e==null?void 0:e.hold)==null?void 0:g.call(e,{useUpdate:!0})))},resume:async()=>{var s,g;await(((s=e==null?void 0:e.unhold)==null?void 0:s.call(e))??((g=e==null?void 0:e.unhold)==null?void 0:g.call(e,{useUpdate:!0})))},sendDTMF:s=>{var g;(g=e==null?void 0:e.sendDTMF)==null||g.call(e,s)},on:(s,g)=>{var u;(u=e==null?void 0:e.on)==null||u.call(e,s,g)}};if(this.config.autoGreet){const s=async()=>{this.emitter.emit("call:answered");try{await this.playGreetIntoSession(e,this.config.greetUrl)}catch{}};e!=null&&e.on&&e.on("accepted",s),this.isJsSipUA&&(e!=null&&e.on)&&e.on("confirmed",s)}return d}async getDevices(){const t=await navigator.mediaDevices.enumerateDevices(),a=t.filter(l=>l.kind==="audioinput"),r=t.filter(l=>l.kind==="audiooutput");return{mics:a,speakers:r}}async setMicrophone(t){}async setOutputDevice(t){const a=this.ensureRemoteAudioEl();await this.setSinkId(a,t||"default")}async teardown(){var t,a;await((a=(t=this.ua)==null?void 0:t.stop)==null?void 0:a.call(t)),this.ua=null}async playGreetIntoSession(t,a){const r=new AudioContext,e=await(await fetch(a)).arrayBuffer(),d=await r.decodeAudioData(e),c=r.createBufferSource();c.buffer=d;const o=r.createMediaStreamDestination();if(c.connect(o),c.start(),t!=null&&t.replaceOutgoingTrack){const[f]=o.stream.getAudioTracks();await t.replaceOutgoingTrack(f),c.addEventListener("ended",async()=>{var s;await((s=t.restoreMicrophoneTrack)==null?void 0:s.call(t))})}}}const Z=new Map,_=new WeakSet;let p=null,U=null,$=null,I=!1,T=null;function dt(){if(document.getElementById("savg-c2c-styles"))return;const n=document.createElement("style");n.id="savg-c2c-styles",n.textContent=`
  .savg-c2c-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); height: min(98svh, 1000px); width: min(98svw, 800px); display: flex; align-items: center; justify-content: center; z-index: 99999; }
  .savg-c2c-card-wrapper { width: 404px; height: 862px; position: relative; z-index: 1; }
  .savg-c2c-card { background: #1c1c1e; color: #e5e5e5; border-radius: 24px; height: 862px; width: 400px; margin: 0 2px; padding: 80px 0 0 0; display: flex; flex-direction: column; justify-content: space-between; gap: 14px; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; box-shadow: inset 0 0 12px #8d8d86, inset 0 7px 0 3px #1077d7, inset 0 -6px 0 3px #1077d7; }
  .savg-c2c-card-wrapper{ will-change: transform, filter; transform-origin: center; }
  .savg-c2c-card-wrapper.crt-enter{ animation: savgCrtIn 320ms ease-out forwards; }
  .savg-c2c-card-wrapper.crt-exit{ animation: savgCrtOut 280ms ease-in forwards; }
  @keyframes savgCrtIn{ 0%{ transform: scaleX(0) scaleY(0); filter: brightness(.7);} 50%{ transform: scaleX(1) scaleY(.02);} 100%{ transform: scaleX(1) scaleY(1); filter:none;} }
  @keyframes savgCrtOut{ 0%{ transform: scaleX(1) scaleY(1);} 50%{ transform: scaleX(1) scaleY(.02);} 100%{ transform: scaleX(0) scaleY(0);} }
  .savg-c2c-title { display: flex; flex-direction: column; gap: 6px; }
  .savg-c2c-meta { display: flex; align-items: center; justify-content: center; }
  .savg-c2c-timer { font-feature-settings: "tnum" 1; font-size: 16px; }
  .savg-c2c-number { font-size: 32px; }
  .savg-c2c-bot { font-size: 14px; }
  .savg-c2c-wave { display: flex; gap: 4px; height: 64px; align-items: flex-end; justify-content: center; }
  .savg-c2c-wave span { display: block; width: 8px; background: #2ecc71; border-radius: 2px; animation: savgPulse 1.2s ease-in-out; min-height: 4px; }
  .savg-c2c-wave span:nth-child(odd){ background:#4da3ff; }
  .savg-c2c-wave span:nth-child(even){ background:#2ecc71; }
  @keyframes savgPulse { 0% { height: 64px; } 100% { height: 4px; } }
  .savg-c2c-keypad-wrapper { background: #2c2c2e; padding: 40px 20px 80px 20px; border-radius: 24px; margin: 0 3px 9px 3px; display: flex; flex-direction: column; gap: 16px; }
  .savg-c2c-keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
  .savg-c2c-btn { padding: 8px; border-radius: 1000px; border: 1px solid #3a3a3c; background: #3a3a3c; color: #e3e3e3; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; }
  .savg-c2c-btn .n { font-size: 16px; }
  .savg-c2c-btn .l { font-size: 12px; opacity: 0.5; }
  .savg-c2c-btn:hover { background: #242424; }
  .savg-c2c-btn:not(.savg-c2c-hangup):active { background: #999; color: #3a3a3c; border-radius: 16px; }
  .savg-c2c-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
  .savg-c2c-mute, .savg-c2c-hangup { padding: 16px; font-size: 20px; }
  .savg-c2c-danger { background: #c23616; border-color: #c23616; grid-column: 2 / 4; }
  .savg-c2c-danger:hover { background: #d63031; border-color: #d63031; }
  .savg-c2c-muted { background: #999; color: #3a3a3c; border-radius: 16px;}
  .savg-c2c-muted:hover { background: #777; }
  .device-stripe::before { background: #16589b; bottom: 0; content: ""; height: 9px; left: 50%; margin-left: 40px; position: absolute; width: 11px; }
  .device-stripe::after { background: linear-gradient(to top, #121212, #666661); border-radius: 50px 50px 0 0; bottom: 0; content: ""; height: 2px; left: 50%; margin-left: -22px; position: absolute; width: 44px; }
  .device-header { background: linear-gradient(to bottom, #8d8d86 0, #16589b 30%, #16589b 100%); height: 10px; left: 50%; margin-left: -147px; position: absolute; top: 0; width: 294px; }
  .device-sensors { background: #121212; border-radius: 50%; height: 22px; left: 50%; margin-left: -11px; margin-top: -11px; position: absolute; top: 39px; width: 22px; }
  .device-sensors::before { background: radial-gradient(farthest-corner at 20% 20%, #6074bf 0, transparent 40%), radial-gradient(farthest-corner at 80% 80%, #513785 0, #24555e 20%, transparent 50%); border-radius: 50%; box-shadow: 0 0 1px 1px rgba(255, 255, 255, .05); height: 8px; left: 7px; top: 7px; width: 8px; content: ""; position: absolute; }
  .device-sensors::after { background: linear-gradient(to bottom, #121212, #666661); border-radius: 0 0 50px 50px; height: 4px; left: 50%; margin-left: -103px; top: -18px; width: 206px; content: ""; position: absolute; }
  .device-btns { background: #16589b; height: 102px; position: absolute; right: 0; top: 306px; width: 3px; }
  .device-power { background: #16589b; height: 58px; position: absolute; right: 0; top: 194px; width: 3px; }

  .savg-c2c-overlay { box-shadow: 0 6px 6px rgba(0, 0, 0, 0.2), 0 0 20px rgba(0, 0, 0, 0.1), 0 -1px 1px 0 white, 0 1px 1px 0 white, 1px 1px 1px 0 rgba(0, 0, 0, 0.2), -1px 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 10px rgba(0, 0, 0, 0.1); border-radius: 24px; }
  .liquidGlass-effect { position: absolute; z-index: 0; inset: 0; backdrop-filter: blur(2px); filter: url(#glass-distortion); overflow: hidden; isolation: isolate; border-radius: inherit; }
  .liquidGlass-tint { z-index: 1; position: absolute; inset: 0; background: rgba(255, 255, 255, 0.25); border-radius: inherit; }
  .liquidGlass-shine { position: absolute; inset: 0; z-index: 2; overflow: hidden; box-shadow: inset 2px 2px 1px 0 rgba(255, 255, 255, 0.5), inset -1px -1px 1px 1px rgba(255, 255, 255, 0.5); border-radius: inherit; }
  .liquidGlass-text { z-index: 3; position: relative; border-radius: inherit; }

  .liquidGlass-effect, .liquidGlass-tint, .liquidGlass-shine { display: none; }
  .savg-c2c-overlay { box-shadow: none; border-radius: 0; backdrop-filter: blur(4px); height: 100svh; width: 100svw; transform: none; inset: 0;}
  `,document.head.appendChild(n)}function ut(){const n="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css";if(!Array.from(document.querySelectorAll('link[rel="stylesheet"]')).some(a=>a.href.includes("bootstrap-icons"))){const a=document.createElement("link");a.rel="stylesheet",a.href=n,a.id="savg-c2c-bootstrap-icons",document.head.appendChild(a)}}function pt(n){const t=Math.floor(n/1e3),a=String(Math.floor(t/60)).padStart(2,"0"),r=String(t%60).padStart(2,"0");return`${a}:${r}`}function gt(n){dt(),ut(),p&&p.remove(),p=document.createElement("div"),p.className="savg-c2c-overlay",p.innerHTML=`
    <div class="liquidGlass-effect"></div>
    <div class="liquidGlass-tint"></div>
    <div class="liquidGlass-shine"></div>
    <div class="liquidGlass-text">
    <div class="savg-c2c-card-wrapper">
      <div class="savg-c2c-card">
        <div class="savg-c2c-title">
          <div class="savg-c2c-meta"><span class="savg-c2c-timer">connecting...</span></div>
          <div class="savg-c2c-meta"><span class="savg-c2c-number">data-botPhoneNumber</span></div>
          <div class="savg-c2c-meta"><span class="savg-c2c-bot">data-botName</span></div>
        </div>
        <div class="savg-c2c-wave" aria-hidden="true">
          <span></span><span></span><span></span><span></span><span></span><span></span>
          <span></span><span></span><span></span><span></span><span></span><span></span>
        </div>
        <div class="savg-c2c-keypad-wrapper">
          <div class="savg-c2c-keypad">
            <button class="savg-c2c-btn" data-key="1"><span class="n">1</span></button>
            <button class="savg-c2c-btn" data-key="2"><span class="n">2</span><span class="l">ABC</span></button>
            <button class="savg-c2c-btn" data-key="3"><span class="n">3</span><span class="l">DEF</span></button>
            <button class="savg-c2c-btn" data-key="4"><span class="n">4</span><span class="l">GHI</span></button>
            <button class="savg-c2c-btn" data-key="5"><span class="n">5</span><span class="l">JKL</span></button>
            <button class="savg-c2c-btn" data-key="6"><span class="n">6</span><span class="l">MNO</span></button>
            <button class="savg-c2c-btn" data-key="7"><span class="n">7</span><span class="l">PQRS</span></button>
            <button class="savg-c2c-btn" data-key="8"><span class="n">8</span><span class="l">TUV</span></button>
            <button class="savg-c2c-btn" data-key="9"><span class="n">9</span><span class="l">WXYZ</span></button>
            <button class="savg-c2c-btn" data-key="*"><span class="n">*</span></button>
            <button class="savg-c2c-btn" data-key="0"><span class="n">0</span><span class="l">+</span></button>
            <button class="savg-c2c-btn" data-key="#"><span class="n">#</span></button>
            </div>
            <div class="savg-c2c-actions">
              <button id="btnMute" class="control savg-c2c-btn savg-c2c-mute" title="Mute/Unmute" aria-label="Mute/Unmute"><i class="bi bi-mic" aria-hidden="true"></i></button>
              <button id="btnEnd" class="hangup savg-c2c-btn savg-c2c-danger savg-c2c-hangup" title="End Call" aria-label="End call"><i class="bi bi-telephone-x" aria-hidden="true"></i></button>
            </div>
          </div>
        </div>
        <div class="device-stripe"></div>
        <div class="device-header"></div>
        <div class="device-sensors"></div>
        <div class="device-btns"></div>
        <div class="device-power"></div>
      </div>
    </div>

    <svg style="display: none">
      <filter id="glass-distortion" x="0%" y="0%" width="100%" height="100%" filterUnits="objectBoundingBox">
        <feTurbulence type="fractalNoise" baseFrequency="0.01 0.01" numOctaves="1" seed="5" result="turbulence" />
        <feComponentTransfer in="turbulence" result="mapped">
        <feFuncR type="gamma" amplitude="1" exponent="10" offset="0.5" />
        <feFuncG type="gamma" amplitude="0" exponent="1" offset="0" />
        <feFuncB type="gamma" amplitude="0" exponent="1" offset="0.5" />
        </feComponentTransfer>
        <feGaussianBlur in="turbulence" stdDeviation="3" result="softMap" />
        <feSpecularLighting in="softMap" surfaceScale="5" specularConstant="1" specularExponent="100" lighting-color="white" result="specLight">
        <fePointLight x="-200" y="-200" z="300" />
        </feSpecularLighting>
        <feComposite in="specLight" operator="arithmetic" k1="0" k2="1" k3="1" k4="0" result="litImage" />
        <feDisplacementMap in="SourceGraphic" in2="softMap" scale="150" xChannelSelector="R" yChannelSelector="G" />
      </filter>
    </svg>`,document.body.appendChild(p),p.querySelector(".savg-c2c-number").textContent=n.number||"Unknown",p.querySelector(".savg-c2c-bot").textContent=n.botLabel||"Bot";const t=p.querySelector(".savg-c2c-card-wrapper");t&&(t.classList.add("crt-enter"),t.addEventListener("animationend",()=>{t.classList.remove("crt-enter")},{once:!0}));const a=p.querySelector(".liquidGlass-text"),r=404,l=862,e=()=>{if(!a)return;const h=Math.max(1,window.innerWidth),i=Math.max(1,window.innerHeight),b=Math.min(h/r,i/l,1);a.style.transform=`scale(${b==1?b:.95*b})`,a.style.transformOrigin="center"};e();const d=()=>e();window.addEventListener("resize",d);const c=p.querySelector(".savg-c2c-mute");c.addEventListener("click",()=>n.onMuteToggle()),p.querySelector(".savg-c2c-hangup").addEventListener("click",()=>n.onHangup()),p.querySelector(".savg-c2c-keypad").querySelectorAll(".savg-c2c-btn").forEach(h=>{h.addEventListener("click",()=>{const i=h.getAttribute("data-key")||h.textContent||"",L={1:[697,1209],2:[697,1336],3:[697,1477],4:[770,1209],5:[770,1336],6:[770,1477],7:[852,1209],8:[852,1336],9:[852,1477],"*":[941,1209],0:[941,1336],"#":[941,1477]}[i.trim()];if(L)try{const j=window.AudioContext||window.webkitAudioContext,y=new j,S=y.createGain();S.gain.value=1e-4,S.connect(y.destination);const x=y.createOscillator();x.type="sine",x.frequency.value=L[0],x.connect(S);const A=y.createOscillator();A.type="sine",A.frequency.value=L[1],A.connect(S);const E=y.currentTime;S.gain.exponentialRampToValueAtTime(.2,E+.01),x.start(E),A.start(E),S.gain.exponentialRampToValueAtTime(1e-4,E+.14),x.stop(E+.16),A.stop(E+.16),setTimeout(()=>{try{y.close()}catch{}},220)}catch{}})});const s=p.querySelector(".savg-c2c-timer");return{startTimer:()=>{$=Date.now(),U&&window.clearInterval(U),U=window.setInterval(()=>{$!=null&&(s.textContent=pt(Date.now()-$))},500)},stop:()=>{U&&window.clearInterval(U),U=null,$=null,I=!1,T&&(cancelAnimationFrame(T),T=null);const h=()=>{p&&(p.remove(),p=null)},i=p==null?void 0:p.querySelector(".savg-c2c-card-wrapper");if(i){i.classList.add("crt-exit");let b=!1;i.addEventListener("animationend",()=>{b||(b=!0,h())},{once:!0}),setTimeout(()=>{b||(b=!0,h())},400)}else h();window.removeEventListener("resize",d)},setMuted:h=>{I=h;const i=c.querySelector("i");i&&(i.className=h?"bi bi-mic-mute":"bi bi-mic"),c.setAttribute("aria-label",h?"Unmute":"Mute"),c.title=h?"Unmute":"Mute",c.classList.toggle("savg-c2c-muted",h)}}}function m(n,t){const a=[t,t.toLowerCase(),t.replace(/[A-Z]/g,r=>"-"+r.toLowerCase()),t.replace(/-/g,"")];for(const r of a){const l=n[r];if(l!=null&&String(l).length>0)return String(l)}}function Q(n){if(n)try{return JSON.parse(n)}catch{return}}function ft(n){const t=[{urls:"stun:stun.l.google.com:19302"}];if(!n)return t;const a=n.replace(/(\{|,|\s)(urls)\s*:/g,'$1"urls":').replace(/(\{|,|\s)(url)\s*:/g,'$1"url":'),r=Q(a);if(Array.isArray(r)){const e=r.map(d=>{if(!d)return null;if(typeof d=="string")return{urls:d};if(Array.isArray(d))return null;const c={};return d.urls?c.urls=d.urls:d.url&&(c.urls=d.url),d.username&&(c.username=d.username),d.credential&&(c.credential=d.credential),c.urls?c:null}).filter(Boolean);if(e.length)return e}const l=n.split(/[\s,]+/).map(e=>e.trim()).filter(Boolean);return l.length?l.map(e=>({urls:e})):t}function ht(n){if(!n)return[];const t=Q(n);return Array.isArray(t)?t.map(String).filter(Boolean):[n]}function mt(n){const t=n.dataset,a=m(t,"addresses"),l=ht(a)[0],e=m(t,"domain"),d=m(t,"botId")||m(t,"botid"),c=m(t,"botName")||m(t,"botname"),o=m(t,"botPhoneNumber")||m(t,"botphonenumber"),f=m(t,"ctcContext")||m(t,"ctccontext"),s=m(t,"iceServers"),g=ft(s),u=m(t,"outputDeviceId")||"default",k=m(t,"displayName")||"Agent",h=m(t,"autoGreet"),i=m(t,"to");return!l||!e||!d||!o?(console.error("[SavgClick2Call] Missing required data-* attributes on button. Need addresses, domain, botId, botPhoneNumber."),{}):{config:{sbcWssUrl:l,sipDomain:e,iceServers:g,displayName:k,botName:c,botId:d,phoneNumber:o,context:f,auth:{username:"embedded",password:"embedded"},audio:{outputDeviceId:u},autoGreet:h?h.toLowerCase()==="true":void 0},to:i}}function bt(n){return`${n.sbcWssUrl}|${n.sipDomain}|${n.botId}`}function vt(n){const t=(n==null?void 0:n.selector)||".click2CallBtn",a=async r=>{var c;const l=r.target;if(!l)return;const e=l.closest(t);if(!(!e||(e.dataset.action||"call").toLowerCase()!=="call")&&!_.has(e)){_.add(e);try{const o=mt(e);if(!o.config)return;const{config:f,to:s}=o,g=bt(f);let u=Z.get(g);u||(u=H(f),Z.set(g,u)),e.disabled=!0;const k=f.phoneNumber||"",h=e.dataset.botName||f.botName||f.botId;let i;const b=gt({number:k,botLabel:h,onDTMF:y=>{try{i==null||i.sendDTMF(y)}catch{}},onMuteToggle:()=>{if(I=!I,I)try{i==null||i.mute()}catch{}else try{i==null||i.unmute()}catch{}b.setMuted(I)},onHangup:async()=>{try{await(i==null?void 0:i.hangup())}catch{}}});(c=f.audio)!=null&&c.outputDeviceId&&await u.setOutputDevice(f.audio.outputDeviceId),await u.register(),i=await u.call({to:s||void 0});const L=async()=>{const y=document.getElementById("savg-c2c-remote-audio"),S=(p==null?void 0:p.querySelectorAll(".savg-c2c-wave span"))||null,x=S?Array.from(S):null;let A=null;const E=100;for(let v=0;v<E;v++){if(y&&y.srcObject instanceof MediaStream){A=y.srcObject;break}await new Promise(C=>setTimeout(C,50))}if(!A||!x||!x.length)return;x.forEach(v=>{v.style.animation="none",v.style.animationName="none"});const tt=window.AudioContext||window.webkitAudioContext;if(!tt)return;const W=new tt,yt=W.createMediaStreamSource(A),D=W.createAnalyser();D.fftSize=256,D.smoothingTimeConstant=.7,yt.connect(D);const X=new Uint8Array(D.frequencyBinCount),Y=new Uint8Array(D.fftSize),et=[2,5,8,11,14,17],at=[3,6,9,12,15,18],nt=()=>{D.getByteFrequencyData(X);let v=0;const C=[...et,...at].slice(0,x.length);for(let w=0;w<C.length;w++)v+=X[C[w]];const N=v<C.length*4;N&&D.getByteTimeDomainData(Y),x.forEach((w,F)=>{const z=(F%2===1?at[Math.floor(F/2)]:et[Math.floor(F/2)])||2,P=N?Math.abs((Y[F*16%Y.length]-128)/128):X[z]/255,q=Math.max(4,Math.floor(P*64));w.style.height=`${q}px`}),T=requestAnimationFrame(nt)};try{await W.resume()}catch{}nt();const st=()=>{T&&(cancelAnimationFrame(T),T=null);try{W.close()}catch{}};try{i.on("ended",st)}catch{}try{i.on("failed",st)}catch{}try{const v=x.filter((C,N)=>N%2===1);if(v.length){const C=await navigator.mediaDevices.getUserMedia({audio:!0}),N=window.AudioContext||window.webkitAudioContext,w=new N,F=w.createMediaStreamSource(C),M=w.createAnalyser();M.fftSize=256,M.smoothingTimeConstant=.8,F.connect(M);const z=new Uint8Array(M.frequencyBinCount),P=new Uint8Array(M.fftSize);let q=null;const it=[3,6,9,12,15,18],V=()=>{if(I){v.forEach(B=>{B.style.height="4px"}),q=requestAnimationFrame(V);return}M.getByteFrequencyData(z);let J=0;for(let B=0;B<v.length;B++)J+=z[it[B]||3];const ct=J<v.length*4;ct&&M.getByteTimeDomainData(P),v.forEach((B,ot)=>{const xt=it[ot]||3,wt=ct?Math.abs((P[ot*16%P.length]-128)/128):z[xt]/255,kt=Math.max(4,Math.floor(wt*64));B.style.height=`${kt}px`}),q=requestAnimationFrame(V)};try{await w.resume()}catch{}V();const rt=()=>{q&&(cancelAnimationFrame(q),q=null);try{w.close()}catch{}try{C.getTracks().forEach(J=>J.stop())}catch{}};try{i.on("ended",rt)}catch{}try{i.on("failed",rt)}catch{}}}catch{}};try{i.on("accepted",()=>{b.startTimer(),L()})}catch{}try{i.on("confirmed",()=>{b.startTimer(),L()})}catch{}const j=()=>{b.stop(),e.disabled=!1};try{i.on("ended",j)}catch{}try{i.on("failed",j)}catch{}}catch(o){console.error("[SavgClick2Call] Call failed:",o)}finally{_.delete(e)}}};document.addEventListener("click",a)}function H(n){return new lt(n)}typeof window<"u"&&(window.SavgClick2Call={createClient:H,autoWireCallButtons:vt}),R.createClient=H,Object.defineProperty(R,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=click2call.umd.js.map
